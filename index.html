  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --success: #38a169;
      --warning: #d69e2e;
      --danger: #e53e3e;
      --gray-100: #f7fafc;
      --gray-200: #edf2f7;
      --gray-300: #e2e8f0;
      --gray-500: #a0aec0;
      --gray-600: #718096;
      --gray-700: #4a5568;
      --gray-800: #2d3748;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* Mobile-first responsive */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px;
    }

    @media (min-width: 768px) {
      .app-container { padding: 20px; }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      margin-bottom: 15px;
    }

    @media (min-width: 768px) {
      .card { padding: 30px; }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .logo span { color: var(--primary); }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--gray-100);
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 14px;
    }

    .user-badge .role {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .logout-btn {
      color: var(--danger);
      cursor: pointer;
      font-size: 13px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 5px;
      background: var(--gray-100);
      padding: 5px;
      border-radius: 12px;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .nav-tab {
      flex: 1;
      min-width: 80px;
      padding: 12px 15px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      color: var(--gray-600);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .nav-tab:hover:not(.active) {
      color: var(--gray-800);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
      }
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-card.success { background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); }
    .stat-card.warning { background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%); }
    .stat-card.info { background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%); }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 5px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: var(--gray-700);
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 14px;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-block { width: 100%; }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--gray-300);
      color: var(--gray-700);
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 12px;
    }

    /* Serial Key Display */
    .key-display {
      background: var(--gray-100);
      border: 2px dashed var(--primary);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
    }

    .key-value {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-800);
      letter-spacing: 2px;
      word-break: break-all;
    }

    @media (min-width: 768px) {
      .key-value { font-size: 28px; }
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
      font-size: 13px;
    }

    th {
      background: var(--gray-100);
      font-weight: 600;
      color: var(--gray-700);
    }

    tr:hover {
      background: var(--gray-100);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-success { background: #c6f6d5; color: #22543d; }
    .badge-warning { background: #fefcbf; color: #744210; }
    .badge-info { background: #bee3f8; color: #2a4365; }
    .badge-danger { background: #fed7d7; color: #742a2a; }

    /* Messages */
    .message {
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .message.success { background: #c6f6d5; color: #22543d; }
    .message.error { background: #fed7d7; color: #742a2a; }
    .message.info { background: #bee3f8; color: #2a4365; }

    /* Charts placeholder */
    .chart-container {
      background: var(--gray-100);
      border-radius: 12px;
      padding: 20px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 15px;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .chart-bar-label {
      width: 100px;
      font-size: 12px;
      color: var(--gray-600);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chart-bar-track {
      flex: 1;
      height: 24px;
      background: var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
    }

    .chart-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #764ba2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      font-size: 11px;
      font-weight: 600;
      color: white;
      min-width: 30px;
    }

    /* Hidden */
    .hidden { display: none !important; }

    /* Login Screen */
    .login-container {
      max-width: 400px;
      margin: 50px auto;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo h1 {
      color: var(--gray-800);
      font-size: 24px;
    }

    .login-logo p {
      color: var(--gray-600);
      font-size: 14px;
      margin-top: 5px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 25px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: var(--gray-500);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-500);
    }

    .empty-state svg {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 30px;
      color: var(--gray-500);
    }

    /* Google Sign-In */
    .google-signin-wrapper {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--gray-500);
      font-size: 12px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--gray-300);
    }

    .divider::before { margin-right: 15px; }
    .divider::after { margin-left: 15px; }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .quick-actions {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .quick-action {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-action:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .quick-action-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .quick-action-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-700);
    }
  </style>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="app-container">

    <!-- ========== LOGIN SCREEN ========== -->
    <div id="loginScreen" class="login-container">
      <div class="card">
        <div class="login-logo">
          <h1>Anvi<span>Shop</span></h1>
          <p>License Management Portal</p>
        </div>

        <div id="loginMessage" class="message hidden"></div>

        <!-- Google Sign-In Button -->
        <div class="google-signin-wrapper">
          <div id="g_id_onload"
               data-client_id="1066277373507-2s05gvn834vmgaif7phjqtpp715b9gu6.apps.googleusercontent.com"
               data-context="signin"
               data-ux_mode="popup"
               data-callback="handleGoogleSignIn"
               data-auto_prompt="false">
          </div>
          <div class="g_id_signin"
               data-type="standard"
               data-shape="rectangular"
               data-theme="outline"
               data-text="signin_with"
               data-size="large"
               data-logo_alignment="left">
          </div>
        </div>

        <div class="divider">ho·∫∑c</div>

        <!-- Password Login Form -->
        <div id="passwordLoginForm">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmailPassword" placeholder="email@company.com" autocomplete="email">
          </div>

          <div class="form-group">
            <label>M·∫≠t kh·∫©u</label>
            <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" autocomplete="current-password">
          </div>

          <button class="btn btn-primary btn-block" onclick="loginWithPassword()">
            üîê ƒêƒÉng Nh·∫≠p
          </button>
        </div>

        <div class="divider">ho·∫∑c</div>

        <!-- Legacy Email Login (Backup) -->
        <details>
          <summary style="cursor:pointer; text-align:center; color:var(--gray-600); font-size:13px; padding:10px;">
            ƒêƒÉng nh·∫≠p ƒë∆°n gi·∫£n (ch·ªâ email)
          </summary>
          <div class="form-group" style="margin-top:10px;">
            <input type="email" id="loginEmail" placeholder="email@company.com" autocomplete="email">
          </div>
          <button class="btn btn-outline btn-block" onclick="login()">
            ƒêƒÉng Nh·∫≠p
          </button>
        </details>

        <p style="text-align:center; margin-top:20px; font-size:12px; color:var(--gray-500);">
          Li√™n h·ªá Admin ƒë·ªÉ ƒë∆∞·ª£c c·∫•p quy·ªÅn truy c·∫≠p
        </p>
      </div>
    </div>
    <!-- ========== MAIN APP ========== -->
    <div id="mainApp" class="hidden">

      <!-- Header -->
      <div class="card">
        <div class="header">
          <div class="logo">Anvi<span>Shop</span> Portal</div>
          <div class="user-badge">
            <span id="displayName">User</span>
            <span class="role" id="displayRole">Sales</span>
            <span class="logout-btn" onclick="logout()">Thoat</span>
          </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs" id="navTabs">
          <div class="nav-tab active" data-tab="dashboard">Dashboard</div>
          <div class="nav-tab" data-tab="getkey">Lay Key</div>
          <div class="nav-tab" data-tab="history">Lich Su</div>
          <div class="nav-tab admin-only hidden" data-tab="manage">Quan Ly</div>
          <div class="nav-tab admin-only hidden" data-tab="stats">Thong Ke</div>
        </div>
      </div>

      <!-- ===== TAB: Dashboard ===== -->
      <div id="tab-dashboard" class="tab-content">
        <div class="card">
          <h2 style="margin-bottom:20px;">Tong Quan</h2>

          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-value" id="statTotal">--</div>
              <div class="stat-label">Tong Keys</div>
            </div>
            <div class="stat-card success">
              <div class="stat-value" id="statActivated">--</div>
              <div class="stat-label">Da Kich Hoat</div>
            </div>
            <div class="stat-card warning">
              <div class="stat-value" id="statAssigned">--</div>
              <div class="stat-label">Da Cap</div>
            </div>
            <div class="stat-card info">
              <div class="stat-value" id="statAvailable">--</div>
              <div class="stat-label">Con Trong</div>
            </div>
          </div>

          <h3 style="margin: 25px 0 15px; font-size:16px;">Thao Tac Nhanh</h3>
          <div class="quick-actions">
            <div class="quick-action" onclick="switchTab('getkey')">
              <div class="quick-action-icon">üîë</div>
              <div class="quick-action-label">Lay Key Moi</div>
            </div>
            <div class="quick-action" onclick="switchTab('history')">
              <div class="quick-action-icon">üìã</div>
              <div class="quick-action-label">Xem Lich Su</div>
            </div>
            <div class="quick-action admin-only hidden" onclick="openModal('generateKeys')">
              <div class="quick-action-icon">‚ö°</div>
              <div class="quick-action-label">Tao Keys</div>
            </div>
            <div class="quick-action admin-only hidden" onclick="openModal('addSales')">
              <div class="quick-action-icon">üë§</div>
              <div class="quick-action-label">Them NV</div>
            </div>
          </div>
        </div>

        <!-- My Performance (for Sales) -->
        <div class="card" id="myPerformance">
          <h3 style="margin-bottom:15px;">Hieu Suat Cua Toi</h3>
          <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
            <div class="stat-card info">
              <div class="stat-value" id="myAssigned">0</div>
              <div class="stat-label">Keys Da Cap</div>
            </div>
            <div class="stat-card success">
              <div class="stat-value" id="myActivated">0</div>
              <div class="stat-label">Da Kich Hoat</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB: Get Key ===== -->
      <div id="tab-getkey" class="tab-content hidden">
        <div class="card">
          <h2 style="margin-bottom:20px;">Lay Serial Key Moi</h2>

          <div id="getKeyMessage" class="message hidden"></div>

          <div class="form-group">
            <label>Ten Khach Hang</label>
            <input type="text" id="customerName" placeholder="Nguyen Van A">
          </div>

          <div class="form-group">
            <label>So Dien Thoai / Email (tuy chon)</label>
            <input type="text" id="customerContact" placeholder="0912345678 hoac email@gmail.com">
          </div>

          <button class="btn btn-primary btn-block" onclick="getNewKey()" id="btnGetKey">
            üîë LAY KEY MOI
          </button>

          <div id="keyResult" class="hidden">
            <div class="key-display">
              <div class="key-value" id="newSerialKey">ANVI-XXXX-XXXX-XXXX</div>
            </div>
            <button class="btn btn-success btn-block" onclick="copyKey()">
              üìã COPY KEY
            </button>
            <p style="text-align:center; margin-top:10px; font-size:12px; color:var(--gray-500);">
              Gui key nay cho khach hang de kich hoat phan mem
            </p>
          </div>
        </div>
      </div>

      <!-- ===== TAB: History ===== -->
      <div id="tab-history" class="tab-content hidden">
        <div class="card">
          <h2 style="margin-bottom:20px;">Lich Su Cap Key</h2>

          <div id="historyLoading" class="loading">
            <div class="spinner"></div>
            Dang tai...
          </div>

          <div id="historyContent" class="hidden">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Serial Key</th>
                    <th>Khach Hang</th>
                    <th>Ngay Cap</th>
                    <th>Trang Thai</th>
                  </tr>
                </thead>
                <tbody id="historyTable"></tbody>
              </table>
            </div>

            <div id="historyEmpty" class="empty-state hidden">
              <p>Chua co key nao duoc cap</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB: Manage (Admin Only) ===== -->
      <div id="tab-manage" class="tab-content hidden">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Quan Ly Nhan Vien</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('addSales')">+ Them NV</button>
          </div>

          <div id="salesLoading" class="loading">
            <div class="spinner"></div>
            Dang tai...
          </div>

          <div id="salesContent" class="hidden">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Ten</th>
                    <th>Keys Cap</th>
                    <th>Da KH</th>
                    <th>Trang Thai</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="salesTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Quan Ly Serial Keys</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('generateKeys')">+ Tao Keys</button>
          </div>

          <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-card info">
              <div class="stat-value" id="keysAvailable2">--</div>
              <div class="stat-label">Con Trong</div>
            </div>
            <div class="stat-card warning">
              <div class="stat-value" id="keysAssigned2">--</div>
              <div class="stat-label">Da Cap</div>
            </div>
            <div class="stat-card success">
              <div class="stat-value" id="keysActivated2">--</div>
              <div class="stat-label">Da Kich Hoat</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB: Stats (Admin Only) ===== -->
      <div id="tab-stats" class="tab-content hidden">
        <div class="card">
          <h2 style="margin-bottom:20px;">Thong Ke Chi Tiet</h2>

          <div class="chart-container" id="salesChart">
            <div class="chart-title">Hieu Suat Theo Nhan Vien</div>
            <div id="salesChartBars">
              <div class="loading">
                <div class="spinner"></div>
                Dang tai...
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin-bottom:20px;">Ti Le Kich Hoat</h2>
          <div id="activationRate" class="stats-grid" style="grid-template-columns: 1fr;">
            <div style="text-align:center; padding:20px;">
              <div style="font-size:48px; font-weight:700; color:var(--success);" id="activationPercent">--%</div>
              <div style="color:var(--gray-600); margin-top:10px;">Keys da cap duoc kich hoat</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ========== MODALS ========== -->

    <!-- Modal: Add Sales -->
    <div id="modal-addSales" class="modal-overlay hidden" onclick="closeModalOnOverlay(event)">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title">Them Nhan Vien Moi</span>
          <span class="modal-close" onclick="closeModal('addSales')">&times;</span>
        </div>

        <div id="addSalesMessage" class="message hidden"></div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="newSalesEmail" placeholder="nhanvien@gmail.com">
        </div>

        <div class="form-group">
          <label>Ten</label>
          <input type="text" id="newSalesName" placeholder="Nguyen Van B">
        </div>

        <button class="btn btn-primary btn-block" onclick="addSales()">Them Nhan Vien</button>
      </div>
    </div>

    <!-- Modal: Generate Keys -->
    <div id="modal-generateKeys" class="modal-overlay hidden" onclick="closeModalOnOverlay(event)">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title">Tao Serial Keys Moi</span>
          <span class="modal-close" onclick="closeModal('generateKeys')">&times;</span>
        </div>

        <div id="generateKeysMessage" class="message hidden"></div>

        <div class="form-group">
          <label>So Luong Keys</label>
          <select id="keysCount">
            <option value="10">10 keys</option>
            <option value="25">25 keys</option>
            <option value="50">50 keys</option>
            <option value="100">100 keys</option>
          </select>
        </div>

        <button class="btn btn-primary btn-block" onclick="generateKeys()">Tao Keys</button>
      </div>
    </div>

  </div>

  <script>
    // ==================== CONFIGURATION ====================
    // IMPORTANT: Replace with your actual Web App URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbzLaSeyv3MBaXYJjtJfFouc2amp-mh9BD8mN95yMwDkBHQV9e7vspAE_i8GjaWRoIXX/exec';
    const ADMIN_KEY = 'anvitech2025'; // For admin stats

    // IMPORTANT: Replace with your Google OAuth Client ID
    const GOOGLE_CLIENT_ID = '1066277373507-2s05gvn834vmgaif7phjqtpp715b9gu6.apps.googleusercontent.com';

    // ==================== STATE ====================
    let currentUser = null;
    let isAdmin = false;
    let statsData = null;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      // Check saved login
      const saved = localStorage.getItem('anviUser');
      if (saved) {
        currentUser = JSON.parse(saved);
        showApp();
      }

      // Tab navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });
    });

    // ==================== AUTH ====================

    // Google Sign-In callback
    function handleGoogleSignIn(response) {
      showMessage('loginMessage', 'Dang xac thuc voi Google...', 'info');

      // response.credential is JWT token from Google
      const idToken = response.credential;

      // Send token to backend for verification
      apiCall('googleLogin', { idToken: idToken })
        .then(data => {
          if (data.success) {
            currentUser = {
              email: data.email,
              name: data.name,
              picture: data.picture,
              isAdmin: data.isAdmin === true,
              authMethod: 'google'
            };
            localStorage.setItem('anviUser', JSON.stringify(currentUser));
            showApp();
          } else {
            showMessage('loginMessage', data.error || 'Dang nhap that bai', 'error');
          }
        })
        .catch(err => {
          showMessage('loginMessage', 'Loi xac thuc: ' + err.message, 'error');
        });
    }

    // Legacy email login (backup for admin)
    function login() {
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      if (!email) {
        showMessage('loginMessage', 'Vui long nhap email', 'error');
        return;
      }

      showMessage('loginMessage', 'Dang dang nhap...', 'info');

      apiCall('salesLogin', { email })
        .then(data => {
          if (data.success) {
            currentUser = {
              email: data.email,
              name: data.name,
              isAdmin: data.isAdmin === true,  // From server (column D in Sales sheet)
              authMethod: 'email'
            };
            localStorage.setItem('anviUser', JSON.stringify(currentUser));
            showApp();
          } else {
            showMessage('loginMessage', data.error || 'Dang nhap that bai', 'error');
          }
        })
        .catch(err => {
          showMessage('loginMessage', 'Loi ket noi: ' + err.message, 'error');
        });
    }

    // Password login
    function loginWithPassword() {
      const email = document.getElementById('loginEmailPassword').value.trim().toLowerCase();
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showMessage('loginMessage', 'Vui long nhap email va mat khau', 'error');
        return;
      }

      showMessage('loginMessage', 'Dang dang nhap...', 'info');

      apiCall('passwordLogin', { email, password })
        .then(data => {
          if (data.success) {
            currentUser = {
              email: data.email,
              name: data.name,
              isAdmin: data.isAdmin === true,
              authMethod: 'password'
            };
            localStorage.setItem('anviUser', JSON.stringify(currentUser));
            showApp();
          } else {
            showMessage('loginMessage', data.error || 'Dang nhap that bai', 'error');
          }
        })
        .catch(err => {
          showMessage('loginMessage', 'Loi ket noi: ' + err.message, 'error');
        });
    }

    function logout() {
      // Sign out from Google if logged in with Google
      if (currentUser && currentUser.authMethod === 'google' && google && google.accounts) {
        google.accounts.id.disableAutoSelect();
      }

      currentUser = null;
      localStorage.removeItem('anviUser');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('loginEmail').value = '';

      // Reload to reset Google Sign-In button
      location.reload();
    }

    function showApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      // Update user info
      document.getElementById('displayName').textContent = currentUser.name;

      // Check admin (from server response)
      isAdmin = currentUser.isAdmin === true;
      document.getElementById('displayRole').textContent = isAdmin ? 'Admin' : 'Sales';

      // Show/hide admin tabs
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle('hidden', !isAdmin);
      });

      // Load data
      loadDashboard();
    }

    // ==================== TABS ====================
    function switchTab(tabName) {
      // Update nav
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Show content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById('tab-' + tabName).classList.remove('hidden');

      // Load data for tab
      if (tabName === 'history') loadHistory();
      if (tabName === 'manage') loadSalesManagement();
      if (tabName === 'stats') loadStats();
    }

    // ==================== DASHBOARD ====================
    function loadDashboard() {
      // Load stats
      apiCall('stats', { adminKey: ADMIN_KEY })
        .then(data => {
          if (data.success) {
            statsData = data;
            document.getElementById('statTotal').textContent = data.total || 0;
            document.getElementById('statActivated').textContent = data.activated || 0;
            document.getElementById('statAssigned').textContent = data.assigned || 0;
            document.getElementById('statAvailable').textContent = data.available || 0;

            // Update manage tab too
            document.getElementById('keysAvailable2').textContent = data.available || 0;
            document.getElementById('keysAssigned2').textContent = data.assigned || 0;
            document.getElementById('keysActivated2').textContent = data.activated || 0;

            // My stats
            if (data.salesStats && data.salesStats[currentUser.email]) {
              const my = data.salesStats[currentUser.email];
              document.getElementById('myAssigned').textContent = (my.assigned || 0) + (my.activated || 0);
              document.getElementById('myActivated').textContent = my.activated || 0;
            }
          }
        })
        .catch(err => console.error('Stats error:', err));
    }

    // ==================== GET KEY ====================
    function getNewKey() {
      const customerName = document.getElementById('customerName').value.trim();
      const customerContact = document.getElementById('customerContact').value.trim();

      const btn = document.getElementById('btnGetKey');
      btn.disabled = true;
      btn.textContent = 'Dang lay key...';

      apiCall('getKey', {
        salesEmail: currentUser.email,
        customerName: customerName,
        customerEmail: customerContact
      })
        .then(data => {
          if (data.success) {
            document.getElementById('newSerialKey').textContent = data.serialKey;
            document.getElementById('keyResult').classList.remove('hidden');
            showMessage('getKeyMessage', 'Da lay key thanh cong!', 'success');

            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';

            // Update stats
            loadDashboard();
          } else {
            showMessage('getKeyMessage', data.error || 'Khong the lay key', 'error');
          }
        })
        .catch(err => {
          showMessage('getKeyMessage', 'Loi: ' + err.message, 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = 'üîë LAY KEY MOI';
        });
    }

    function copyKey() {
      const key = document.getElementById('newSerialKey').textContent;

      if (navigator.clipboard) {
        navigator.clipboard.writeText(key).then(() => {
          alert('Da copy: ' + key);
        });
      } else {
        // Fallback
        const input = document.createElement('input');
        input.value = key;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('Da copy: ' + key);
      }
    }

    // ==================== HISTORY ====================
    function loadHistory() {
      const loading = document.getElementById('historyLoading');
      const content = document.getElementById('historyContent');

      loading.classList.remove('hidden');
      content.classList.add('hidden');

      apiCall('salesHistory', { email: currentUser.email })
        .then(data => {
          loading.classList.add('hidden');
          content.classList.remove('hidden');

          if (data.success) {
            const table = document.getElementById('historyTable');
            const empty = document.getElementById('historyEmpty');

            if (!data.history || data.history.length === 0) {
              table.innerHTML = '';
              empty.classList.remove('hidden');
              return;
            }

            empty.classList.add('hidden');
            table.innerHTML = data.history.map(h => `
              <tr>
                <td style="font-family:monospace; font-weight:600;">${h.serialKey}</td>
                <td>${h.customerName || '-'}</td>
                <td>${formatDate(h.assignedDate)}</td>
                <td>
                  <span class="badge ${h.activated ? 'badge-success' : 'badge-warning'}">
                    ${h.activated ? 'Da KH' : 'Chua KH'}
                  </span>
                </td>
              </tr>
            `).join('');
          }
        })
        .catch(err => {
          loading.classList.add('hidden');
          console.error('History error:', err);
        });
    }

    // ==================== SALES MANAGEMENT (Admin) ====================
    function loadSalesManagement() {
      if (!isAdmin) return;

      const loading = document.getElementById('salesLoading');
      const content = document.getElementById('salesContent');

      loading.classList.remove('hidden');
      content.classList.add('hidden');

      // Get sales list with stats
      apiCall('stats', { adminKey: ADMIN_KEY })
        .then(data => {
          loading.classList.add('hidden');
          content.classList.remove('hidden');

          if (data.success && data.salesStats) {
            const table = document.getElementById('salesTable');
            const salesList = Object.entries(data.salesStats);

            if (salesList.length === 0) {
              table.innerHTML = '<tr><td colspan="6" style="text-align:center;">Chua co nhan vien nao</td></tr>';
              return;
            }

            table.innerHTML = salesList.map(([email, stats]) => `
              <tr>
                <td>${email}</td>
                <td>-</td>
                <td>${(stats.assigned || 0) + (stats.activated || 0)}</td>
                <td>${stats.activated || 0}</td>
                <td><span class="badge badge-success">Active</span></td>
                <td><button class="btn btn-outline btn-sm" onclick="viewSalesDetail('${email}')">Chi tiet</button></td>
              </tr>
            `).join('');
          }
        })
        .catch(err => {
          loading.classList.add('hidden');
          console.error('Sales error:', err);
        });
    }

    function viewSalesDetail(email) {
      alert('Chi tiet cua: ' + email + '\n(Tinh nang dang phat trien)');
    }

    // ==================== STATS (Admin) ====================
    function loadStats() {
      if (!isAdmin) return;

      apiCall('stats', { adminKey: ADMIN_KEY })
        .then(data => {
          if (data.success) {
            // Sales chart
            const chartBars = document.getElementById('salesChartBars');
            if (data.salesStats) {
              const salesList = Object.entries(data.salesStats);
              const maxVal = Math.max(...salesList.map(([,s]) => (s.assigned || 0) + (s.activated || 0)), 1);

              if (salesList.length === 0) {
                chartBars.innerHTML = '<div class="empty-state">Chua co du lieu</div>';
              } else {
                chartBars.innerHTML = salesList.map(([email, stats]) => {
                  const total = (stats.assigned || 0) + (stats.activated || 0);
                  const pct = Math.round((total / maxVal) * 100);
                  return `
                    <div class="chart-bar">
                      <div class="chart-bar-label" title="${email}">${email.split('@')[0]}</div>
                      <div class="chart-bar-track">
                        <div class="chart-bar-fill" style="width:${pct}%">${total}</div>
                      </div>
                    </div>
                  `;
                }).join('');
              }
            }

            // Activation rate
            const assigned = data.assigned || 0;
            const activated = data.activated || 0;
            const totalUsed = assigned + activated;
            const rate = totalUsed > 0 ? Math.round((activated / totalUsed) * 100) : 0;
            document.getElementById('activationPercent').textContent = rate + '%';
          }
        })
        .catch(err => console.error('Stats error:', err));
    }

    // ==================== MODALS ====================
    function openModal(name) {
      document.getElementById('modal-' + name).classList.remove('hidden');
    }

    function closeModal(name) {
      document.getElementById('modal-' + name).classList.add('hidden');
    }

    function closeModalOnOverlay(e) {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.add('hidden');
      }
    }

    function addSales() {
      const email = document.getElementById('newSalesEmail').value.trim().toLowerCase();
      const name = document.getElementById('newSalesName').value.trim();

      if (!email || !name) {
        showMessage('addSalesMessage', 'Vui long nhap day du thong tin', 'error');
        return;
      }

      apiCall('addSales', {
        adminKey: ADMIN_KEY,
        email: email,
        name: name
      })
        .then(data => {
          if (data.success) {
            showMessage('addSalesMessage', 'Da them nhan vien thanh cong!', 'success');
            document.getElementById('newSalesEmail').value = '';
            document.getElementById('newSalesName').value = '';
            loadSalesManagement();
            setTimeout(() => closeModal('addSales'), 1500);
          } else {
            showMessage('addSalesMessage', data.error || 'Khong the them', 'error');
          }
        })
        .catch(err => {
          showMessage('addSalesMessage', 'Loi: ' + err.message, 'error');
        });
    }

    function generateKeys() {
      const count = parseInt(document.getElementById('keysCount').value);

      showMessage('generateKeysMessage', 'Dang tao keys...', 'info');

      apiCall('generateKeys', {
        adminKey: ADMIN_KEY,
        count: count
      })
        .then(data => {
          if (data.success) {
            showMessage('generateKeysMessage', `Da tao ${count} keys thanh cong!`, 'success');
            loadDashboard();
            setTimeout(() => closeModal('generateKeys'), 1500);
          } else {
            showMessage('generateKeysMessage', data.error || 'Khong the tao keys', 'error');
          }
        })
        .catch(err => {
          showMessage('generateKeysMessage', 'Loi: ' + err.message, 'error');
        });
    }

    // ==================== API HELPER ====================
    function apiCall(action, data = {}) {
      return fetch(API_URL + '?action=' + action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(r => r.json());
    }

    // ==================== UTILS ====================
    function showMessage(id, text, type) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = 'message ' + type;
      el.classList.remove('hidden');

      if (type !== 'info') {
        setTimeout(() => el.classList.add('hidden'), 5000);
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('vi-VN');
      } catch {
        return dateStr;
      }
    }
  </script>
</body>
</html>
