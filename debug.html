<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug API - AnviShop</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .test-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    .test-box h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    .result {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    .result.show { display: block; }
    .result.success { border-color: #28a745; background: #d4edda; }
    .result.error { border-color: #dc3545; background: #f8d7da; }
    .result.info { border-color: #17a2b8; background: #d1ecf1; }
    .api-info {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .api-info code {
      background: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      word-break: break-all;
    }
    .instructions {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
    }
    .instructions ol {
      margin-left: 20px;
      margin-top: 10px;
    }
    .instructions li {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug API AnviShop</h1>
    <p class="subtitle">Ki·ªÉm tra k·∫øt n·ªëi v√† ch·ª©c nƒÉng API</p>

    <div class="api-info">
      <strong>üì° API URL:</strong><br>
      <code id="apiUrl"></code>
    </div>

    <div class="instructions">
      <strong>üìã H∆Ø·ªöNG D·∫™N:</strong>
      <ol>
        <li>Ch·∫°y c√°c test theo th·ª© t·ª± t·ª´ tr√™n xu·ªëng</li>
        <li>N·∫øu test n√†o FAILED, ch·ª•p m√†n h√¨nh k·∫øt qu·∫£</li>
        <li>G·ª≠i screenshot cho t√¥i ƒë·ªÉ debug</li>
      </ol>
    </div>

    <!-- TEST 1 -->
    <div class="test-box">
      <h3>‚úÖ TEST 1: Ki·ªÉm tra k·∫øt n·ªëi API</h3>
      <button onclick="test1()">‚ñ∂ Ch·∫°y Test 1</button>
      <div id="result1" class="result"></div>
    </div>

    <!-- TEST 2 -->
    <div class="test-box">
      <h3>‚úÖ TEST 2: Ki·ªÉm tra function googleLogin</h3>
      <button onclick="test2()">‚ñ∂ Ch·∫°y Test 2</button>
      <div id="result2" class="result"></div>
    </div>

    <!-- TEST 3 -->
    <div class="test-box">
      <h3>‚úÖ TEST 3: Ki·ªÉm tra function salesLogin</h3>
      <input type="email" id="emailTest3" placeholder="Nh·∫≠p email c·ªßa b·∫°n (trong Sheet Sales)" value="">
      <button onclick="test3()">‚ñ∂ Ch·∫°y Test 3</button>
      <div id="result3" class="result"></div>
    </div>

    <!-- TEST 4 -->
    <div class="test-box">
      <h3>‚úÖ TEST 4: Ki·ªÉm tra Sheet Sales</h3>
      <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
        Test n√†y s·∫Ω th·ª≠ l·∫•y th√¥ng tin t·ª´ email c·ªßa b·∫°n
      </p>
      <input type="email" id="emailTest4" placeholder="Nh·∫≠p email c·ªßa b·∫°n" value="">
      <button onclick="test4()">‚ñ∂ Ch·∫°y Test 4</button>
      <div id="result4" class="result"></div>
    </div>

    <!-- TEST 5 -->
    <div class="test-box">
      <h3>‚úÖ TEST 5: Ki·ªÉm tra CORS</h3>
      <button onclick="test5()">‚ñ∂ Ch·∫°y Test 5</button>
      <div id="result5" class="result"></div>
    </div>

  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz583swcb9_ogM3pHGpLKiM7_-1BXIwxwLDsejQ8CSqxEDR0Um113hlXdBxCQmTkjC0/exec';
    
    document.getElementById('apiUrl').textContent = API_URL;

    function showResult(id, text, type = 'info') {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = 'result show ' + type;
    }

    function apiCall(action, data = {}) {
      const url = API_URL + '?action=' + action;
      
      return fetch(url, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
        mode: 'cors'
      })
      .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        return response.json();
      })
      .catch(error => {
        console.error('Fetch error:', error);
        throw error;
      });
    }

    // TEST 1: K·∫øt n·ªëi c∆° b·∫£n
    async function test1() {
      showResult('result1', '‚è≥ ƒêang test k·∫øt n·ªëi...', 'info');
      
      try {
        const response = await fetch(API_URL + '?action=salesLogin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        showResult('result1', 
          '‚úÖ TEST 1: PASSED\n\n' +
          'K·∫øt n·ªëi API th√†nh c√¥ng!\n\n' +
          'Response:\n' + JSON.stringify(data, null, 2),
          'success'
        );
      } catch (error) {
        showResult('result1',
          '‚ùå TEST 1: FAILED\n\n' +
          'L·ªói k·∫øt n·ªëi:\n' + error.message + '\n\n' +
          'Nguy√™n nh√¢n c√≥ th·ªÉ:\n' +
          '1. Apps Script ch∆∞a deploy\n' +
          '2. API_URL sai\n' +
          '3. Permission ch∆∞a set "Anyone"',
          'error'
        );
      }
    }

    // TEST 2: Function googleLogin
    async function test2() {
      showResult('result2', '‚è≥ ƒêang test function googleLogin...', 'info');
      
      try {
        const data = await apiCall('googleLogin', { credential: 'fake_token' });
        
        if (data.error && data.error.includes('Token')) {
          showResult('result2',
            '‚úÖ TEST 2: PASSED\n\n' +
            'Function googleLogin T·ªíN T·∫†I!\n\n' +
            'Response:\n' + JSON.stringify(data, null, 2),
            'success'
          );
        } else {
          showResult('result2',
            '‚ö†Ô∏è TEST 2: UNEXPECTED\n\n' +
            'Function c√≥ v·∫ª t·ªìn t·∫°i nh∆∞ng response l·∫°:\n' +
            JSON.stringify(data, null, 2),
            'info'
          );
        }
      } catch (error) {
        showResult('result2',
          '‚ùå TEST 2: FAILED\n\n' +
          'Function googleLogin CH∆ØA C√ì ho·∫∑c c√≥ l·ªói!\n\n' +
          'Error: ' + error.message + '\n\n' +
          'Gi·∫£i ph√°p:\n' +
          '1. Ki·ªÉm tra Code.gs ƒë√£ paste ƒë√∫ng ch∆∞a\n' +
          '2. Deploy l·∫°i v·ªõi New version',
          'error'
        );
      }
    }

    // TEST 3: Function salesLogin v·ªõi email
    async function test3() {
      const email = document.getElementById('emailTest3').value.trim();
      
      if (!email) {
        showResult('result3', '‚ùå Vui l√≤ng nh·∫≠p email!', 'error');
        return;
      }
      
      showResult('result3', '‚è≥ ƒêang test salesLogin v·ªõi email: ' + email, 'info');
      
      try {
        const data = await apiCall('salesLogin', { email: email });
        
        if (data.success) {
          showResult('result3',
            '‚úÖ TEST 3: PASSED\n\n' +
            'Email T·ªíN T·∫†I trong Sheet Sales!\n\n' +
            'User Info:\n' + JSON.stringify(data, null, 2) + '\n\n' +
            '‚Üí B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ƒë∆∞·ª£c!',
            'success'
          );
        } else {
          showResult('result3',
            '‚ùå TEST 3: FAILED\n\n' +
            'Email KH√îNG T·ªíN T·∫†I ho·∫∑c b·ªã v√¥ hi·ªáu h√≥a!\n\n' +
            'Error: ' + data.error + '\n\n' +
            'Gi·∫£i ph√°p:\n' +
            '1. Ki·ªÉm tra Sheet "Sales" c√≥ email n√†y ch∆∞a\n' +
            '2. Ki·ªÉm tra IsActive = TRUE\n' +
            '3. Ki·ªÉm tra ch√≠nh t·∫£ email',
            'error'
          );
        }
      } catch (error) {
        showResult('result3',
          '‚ùå TEST 3: ERROR\n\n' +
          'L·ªói g·ªçi API:\n' + error.message,
          'error'
        );
      }
    }

    // TEST 4: Ki·ªÉm tra chi ti·∫øt Sheet
    async function test4() {
      const email = document.getElementById('emailTest4').value.trim();
      
      if (!email) {
        showResult('result4', '‚ùå Vui l√≤ng nh·∫≠p email!', 'error');
        return;
      }
      
      showResult('result4', '‚è≥ ƒêang ki·ªÉm tra Sheet Sales...', 'info');
      
      try {
        // Try to get sales history (only works if email exists)
        const data = await apiCall('salesHistory', { email: email });
        
        if (data.success !== undefined) {
          showResult('result4',
            '‚úÖ TEST 4: PASSED\n\n' +
            'Sheet Sales ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!\n\n' +
            'Response:\n' + JSON.stringify(data, null, 2),
            'success'
          );
        } else {
          showResult('result4',
            '‚ö†Ô∏è TEST 4: UNCLEAR\n\n' +
            'Response:\n' + JSON.stringify(data, null, 2),
            'info'
          );
        }
      } catch (error) {
        showResult('result4',
          '‚ùå TEST 4: ERROR\n\n' +
          'Error: ' + error.message,
          'error'
        );
      }
    }

    // TEST 5: CORS
    async function test5() {
      showResult('result5', '‚è≥ ƒêang test CORS...', 'info');
      
      try {
        const response = await fetch(API_URL + '?action=salesLogin', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Origin': window.location.origin
          },
          body: JSON.stringify({}),
          mode: 'cors',
          credentials: 'omit'
        });
        
        const corsHeaders = {
          'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
          'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
          'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
        };
        
        showResult('result5',
          '‚úÖ TEST 5: PASSED\n\n' +
          'CORS Headers:\n' + JSON.stringify(corsHeaders, null, 2) + '\n\n' +
          'Response status: ' + response.status,
          'success'
        );
      } catch (error) {
        showResult('result5',
          '‚ùå TEST 5: FAILED\n\n' +
          'CORS Error:\n' + error.message + '\n\n' +
          'Gi·∫£i ph√°p:\n' +
          '1. Deploy Apps Script v·ªõi "Who has access: Anyone"\n' +
          '2. ƒê·∫£m b·∫£o Apps Script c√≥ handleRequest() ƒë√∫ng',
          'error'
        );
      }
    }

    // Auto-run Test 1 on load
    window.onload = function() {
      console.log('Debug page loaded');
      console.log('API URL:', API_URL);
    };
  </script>
</body>
</html>
